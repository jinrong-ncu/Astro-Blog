---
// AppStoreTabBar.astro - 真正的 Apple App Store 底部导航栏（带气泡背景）
interface Props {
  activeTab?: number;
}

const { activeTab = 0 } = Astro.props;

const tabs = [
  { id: 'today', label: 'Today' },
  { id: 'games', label: 'Games' },
  { id: 'apps', label: 'Apps' },
  { id: 'arcade', label: 'Arcade' },
  { id: 'search', label: 'Search' }
];
---

<div class="app-store-tab-bar">
  {tabs.map((tab, index) => (
    <button 
      class={`tab-item ${index === activeTab ? 'active' : ''}`}
      data-tab={tab.id}
      data-index={index}
    >
      {/* 气泡背景层 - 只在选中时显示 */}
      <div class="bubble-bg"></div>
      
      {/* 图标和文字层 */}
      <div class="tab-content">
        <div class="tab-icon-wrapper">
          {/* Today - 日历 */}
          {tab.id === 'today' && (
            <>
              <svg class="icon-outline" width="26" height="26" viewBox="0 0 26 26" fill="none">
                <rect x="4" y="5" width="18" height="17" rx="2.5" stroke="currentColor" stroke-width="1.8"/>
                <line x1="4" y1="10" x2="22" y2="10" stroke="currentColor" stroke-width="1.8"/>
                <line x1="8" y1="3" x2="8" y2="7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                <line x1="18" y1="3" x2="18" y2="7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
              </svg>
              <svg class="icon-filled" width="26" height="26" viewBox="0 0 26 26" fill="none">
                <rect x="4" y="5" width="18" height="17" rx="2.5" fill="currentColor"/>
                <rect x="4" y="5" width="18" height="5" fill="currentColor" opacity="0.7"/>
                <line x1="8" y1="3" x2="8" y2="7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                <line x1="18" y1="3" x2="18" y2="7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
              </svg>
            </>
          )}
          {/* Games - 游戏手柄 */}
          {tab.id === 'games' && (
            <>
              <svg class="icon-outline" width="26" height="26" viewBox="0 0 26 26" fill="none">
                <path d="M5 13C5 10.7909 6.79086 9 9 9H17C19.2091 9 21 10.7909 21 13V15C21 17.2091 19.2091 19 17 19H9C6.79086 19 5 17.2091 5 15V13Z" stroke="currentColor" stroke-width="1.8"/>
                <circle cx="9.5" cy="14" r="1" fill="currentColor"/>
                <circle cx="16.5" cy="13" r="0.8" fill="currentColor"/>
                <circle cx="16.5" cy="15" r="0.8" fill="currentColor"/>
              </svg>
              <svg class="icon-filled" width="26" height="26" viewBox="0 0 26 26" fill="none">
                <path d="M5 13C5 10.7909 6.79086 9 9 9H17C19.2091 9 21 10.7909 21 13V15C21 17.2091 19.2091 19 17 19H9C6.79086 19 5 17.2091 5 15V13Z" fill="currentColor"/>
                <circle cx="9.5" cy="14" r="1.2" fill="white"/>
                <circle cx="16.5" cy="13" r="1" fill="white"/>
                <circle cx="16.5" cy="15" r="1" fill="white"/>
              </svg>
            </>
          )}
          {/* Apps - 网格 */}
          {tab.id === 'apps' && (
            <>
              <svg class="icon-outline" width="26" height="26" viewBox="0 0 26 26" fill="none">
                <rect x="5" y="5" width="6.5" height="6.5" rx="1.5" stroke="currentColor" stroke-width="1.8"/>
                <rect x="14.5" y="5" width="6.5" height="6.5" rx="1.5" stroke="currentColor" stroke-width="1.8"/>
                <rect x="5" y="14.5" width="6.5" height="6.5" rx="1.5" stroke="currentColor" stroke-width="1.8"/>
                <rect x="14.5" y="14.5" width="6.5" height="6.5" rx="1.5" stroke="currentColor" stroke-width="1.8"/>
              </svg>
              <svg class="icon-filled" width="26" height="26" viewBox="0 0 26 26" fill="none">
                <rect x="5" y="5" width="6.5" height="6.5" rx="1.5" fill="currentColor"/>
                <rect x="14.5" y="5" width="6.5" height="6.5" rx="1.5" fill="currentColor"/>
                <rect x="5" y="14.5" width="6.5" height="6.5" rx="1.5" fill="currentColor"/>
                <rect x="14.5" y="14.5" width="6.5" height="6.5" rx="1.5" fill="currentColor"/>
              </svg>
            </>
          )}
          {/* Arcade - 游戏机 */}
          {tab.id === 'arcade' && (
            <>
              <svg class="icon-outline" width="26" height="26" viewBox="0 0 26 26" fill="none">
                <path d="M5 11C5 9.34315 6.34315 8 8 8H18C19.6569 8 21 9.34315 21 11V17C21 18.6569 19.6569 20 18 20H8C6.34315 20 5 18.6569 5 17V11Z" stroke="currentColor" stroke-width="1.8"/>
                <line x1="9" y1="14" x2="11" y2="14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                <line x1="10" y1="13" x2="10" y2="15" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                <circle cx="16" cy="13" r="0.8" fill="currentColor"/>
                <circle cx="18" cy="15" r="0.8" fill="currentColor"/>
              </svg>
              <svg class="icon-filled" width="26" height="26" viewBox="0 0 26 26" fill="none">
                <path d="M5 11C5 9.34315 6.34315 8 8 8H18C19.6569 8 21 9.34315 21 11V17C21 18.6569 19.6569 20 18 20H8C6.34315 20 5 18.6569 5 17V11Z" fill="currentColor"/>
                <line x1="9" y1="14" x2="11" y2="14" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
                <line x1="10" y1="13" x2="10" y2="15" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
                <circle cx="16" cy="13" r="1" fill="white"/>
                <circle cx="18" cy="15" r="1" fill="white"/>
              </svg>
            </>
          )}
          {/* Search - 搜索 */}
          {tab.id === 'search' && (
            <>
              <svg class="icon-outline" width="26" height="26" viewBox="0 0 26 26" fill="none">
                <circle cx="11" cy="11" r="5.5" stroke="currentColor" stroke-width="1.8"/>
                <path d="M15 15L20 20" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
              </svg>
              <svg class="icon-filled" width="26" height="26" viewBox="0 0 26 26" fill="none">
                <circle cx="11" cy="11" r="5.5" fill="currentColor"/>
                <path d="M15 15L20 20" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
              </svg>
            </>
          )}
        </div>
        <span class="tab-label">{tab.label}</span>
      </div>
    </button>
  ))}
</div>

<style>
  .app-store-tab-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-around;
    align-items: flex-end;
    padding: 8px 8px calc(20px + env(safe-area-inset-bottom));
    
    /* 环境顶光渐变 */
    background: linear-gradient(
      to bottom,
      rgba(249, 249, 249, 0.72) 0%,
      rgba(242, 242, 247, 0.8) 100%
    );
    
    /* 极高质量毛玻璃 */
    backdrop-filter: saturate(180%) blur(25px);
    -webkit-backdrop-filter: saturate(180%) blur(25px);
    
    /* 玻璃切割边缘 */
    border-top: 0.5px solid rgba(0, 0, 0, 0.1);
    box-shadow: 
      inset 0 1px 0 0 rgba(255, 255, 255, 0.8),
      0 -1px 8px rgba(0, 0, 0, 0.04);
    
    z-index: 1000;
  }

  .tab-item {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4px 12px;
    background: transparent;
    border: none;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    -webkit-user-select: none;
    flex: 1;
    max-width: 80px;
  }

  /* 核心：圆形气泡背景 - 只在选中时显示 */
  .bubble-bg {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    width: 56px;
    height: 56px;
    border-radius: 50%;
    
    /* 毛玻璃气泡 */
    background: rgba(255, 255, 255, 0.18);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 
      inset 0 0 0 0.5px rgba(255, 255, 255, 0.3),
      0 4px 12px rgba(0, 0, 0, 0.08);
    
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    z-index: 0;
  }

  /* 选中时气泡显现 */
  .tab-item.active .bubble-bg {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }

  /* 按压时气泡微微缩小 */
  .tab-item:active .bubble-bg {
    transform: translate(-50%, -50%) scale(0.92);
    transition: all 0.1s ease;
  }

  /* 内容层 */
  .tab-content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    transition: transform 0.1s ease;
  }

  /* 按压时内容微微缩小 */
  .tab-item:active .tab-content {
    transform: scale(0.95);
  }

  /* 图标容器 - 双图标叠加 */
  .tab-icon-wrapper {
    position: relative;
    width: 26px;
    height: 26px;
  }

  .tab-icon-wrapper svg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  }

  /* 默认显示线条图标 */
  .icon-outline {
    opacity: 1;
    color: #8e8e93;
    transform: scale(1);
  }

  .icon-filled {
    opacity: 0;
    color: #007AFF;
    transform: scale(0.7);
  }

  /* 选中态：填充图标显现 */
  .tab-item.active .icon-outline {
    opacity: 0;
    transform: scale(1.2);
  }

  .tab-item.active .icon-filled {
    opacity: 1;
    transform: scale(1);
  }

  /* 文字标签 */
  .tab-label {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
    font-size: 10px;
    font-weight: 500;
    line-height: 1.2;
    letter-spacing: -0.08px;
    color: #8e8e93;
    transition: color 0.3s ease;
  }

  .tab-item.active .tab-label {
    color: #007AFF;
  }

  /* Hover 效果（仅桌面端） */
  @media (hover: hover) {
    .tab-item:hover:not(.active) {
      opacity: 0.7;
    }
  }

  /* 深色模式 */
  @media (prefers-color-scheme: dark) {
    .app-store-tab-bar {
      background: linear-gradient(
        to bottom,
        rgba(28, 28, 30, 0.68) 0%,
        rgba(18, 18, 20, 0.8) 100%
      );
      border-top: 0.5px solid rgba(255, 255, 255, 0.12);
      box-shadow: 
        inset 0 1px 0 0 rgba(255, 255, 255, 0.08),
        0 -1px 8px rgba(0, 0, 0, 0.3);
    }

    /* 深色模式下的气泡 */
    .bubble-bg {
      background: rgba(255, 255, 255, 0.12);
      box-shadow: 
        inset 0 0 0 0.5px rgba(255, 255, 255, 0.2),
        0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .icon-outline {
      color: #98989d;
    }

    .icon-filled {
      color: #0A84FF;
    }

    .tab-label {
      color: #98989d;
    }

    .tab-item.active .tab-label {
      color: #0A84FF;
    }
  }
</style>

<script>
  function initAppStoreTabBar() {
    const tabBar = document.querySelector('.app-store-tab-bar');
    if (!tabBar) return;

    const tabs = tabBar.querySelectorAll('.tab-item');

    // iOS Safari 兼容性：激活 :active 伪类
    tabs.forEach((tab) => {
      tab.addEventListener('touchstart', () => {}, { passive: true });

      tab.addEventListener('click', () => {
        // 移除所有激活状态
        tabs.forEach(t => t.classList.remove('active'));
        
        // 激活当前 Tab
        tab.classList.add('active');

        // 触觉反馈
        if ('vibrate' in navigator) {
          navigator.vibrate(10);
        }
      });
    });
  }

  // 初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAppStoreTabBar);
  } else {
    initAppStoreTabBar();
  }

  // 支持 Astro View Transitions
  document.addEventListener('astro:page-load', initAppStoreTabBar);
</script>
