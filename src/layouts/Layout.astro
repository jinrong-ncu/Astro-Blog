---
import { ClientRouter } from "astro:transitions";
import ThemeToggle from "../components/ThemeToggle";
import Search from "../components/Search.astro";
import { SITE_TITLE, SITE_DESCRIPTION, AUTHOR } from "../consts";

interface Props {
  title: string;
  description?: string;
}

const { title, description = SITE_DESCRIPTION } = Astro.props;
---

<!doctype html>
<html lang="zh-CN" class="scroll-smooth">
  <head>
    <meta name="baidu-site-verification" content="codeva-Bq9PHADdgr" />
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    <meta
      property="og:image"
      content={new URL(
        `/og/${Astro.url.pathname === "/" ? "hello-刘金荣" : Astro.url.pathname.replace(/^\/blog\//, "").replace(/\/$/, "")}.png`,
        Astro.site || "http://localhost:4321",
      ).href}
    />
    <meta name="twitter:card" content="summary_large_image" />
    <ClientRouter />

    <script is:inline>
      const getTheme = () => {
        if (
          typeof localStorage !== "undefined" &&
          localStorage.getItem("theme")
        ) {
          return localStorage.getItem("theme");
        }
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
          return "dark";
        }
        return "light";
      };

      const theme = getTheme();
      if (theme === "dark") {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }

      document.addEventListener("astro:after-swap", () => {
        const theme = getTheme();
        if (theme === "dark") {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }
      });
    </script>
    <!-- <script
      async
      src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <script>
      // Reload Busuanzi on page swap for View Transitions
      document.addEventListener("astro:page-load", () => {
        // @ts-ignore
        if (window.bszCaller && window.bszTag) {
          // @ts-ignore
          window.bszTag.hides();
          // @ts-ignore
          window.bszTag.shows();
          // @ts-ignore
          window.bszCaller.fetch(
            "//busuanzi.ibruce.info/busuanzi?jsonpCallback=BusuanziCallback",
            function (a) {
              // @ts-ignore
              window.bszTag.hides();
              // @ts-ignore
              window.bszTag.shows();
            },
          );
        }
      });
    </script> -->
    <script>
      document.addEventListener("astro:page-load", () => {
        const bszSrc =
          "//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js";

        // 1. 如果页面上已经有这个脚本了，先删掉它
        const oldScript = document.querySelector(`script[src="${bszSrc}"]`);
        if (oldScript) {
          oldScript.remove();
        }

        // 2. 【关键步骤】暴力清除不蒜子的全局缓存变量
        // 如果不加这两行，不蒜子会以为自己已经加载过了，就不会再次执行
        // @ts-ignore
        window.bszCaller = undefined;
        // @ts-ignore
        window.bszTag = undefined;

        // 3. 创建一个新的脚本标签并插入
        const newScript = document.createElement("script");
        newScript.src = bszSrc;
        newScript.async = true;
        newScript.referrerPolicy = "no-referrer-when-downgrade";

        document.body.appendChild(newScript);
      });
    </script>
    <script is:inline>
      (function () {
        var bp = document.createElement("script");
        var curProtocol = window.location.protocol.split(":")[0];
        if (curProtocol === "https") {
          bp.src = "https://zz.bdstatic.com/linksubmit/push.js";
        } else {
          bp.src = "http://push.zhanzhang.baidu.com/push.js";
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  </head>
  <body
    class="flex flex-col min-h-screen selection:bg-purple-100 selection:text-purple-900 dark:selection:bg-purple-900/30 dark:selection:text-purple-200"
  >
    <header
      class="sticky top-0 z-50 w-full border-b border-zinc-200/40 dark:border-zinc-800/40 bg-white/80 dark:bg-zinc-950/80 backdrop-blur-md supports-[backdrop-filter]:bg-white/60 dark:supports-[backdrop-filter]:bg-zinc-950/60 transition-colors"
    >
      <nav
        class="flex h-16 items-center justify-between px-6 max-w-5xl mx-auto"
      >
        <a href="/" class="flex items-center gap-2 group">
          <div
            class="p-1.5 bg-zinc-900 dark:bg-white rounded-lg group-hover:bg-zinc-800 dark:group-hover:bg-zinc-200 transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="text-white dark:text-zinc-900"
              ><path d="m18 16 4-4-4-4"></path><path d="m6 8-4 4 4 4"
              ></path><path d="m14.5 4-5 16"></path></svg
            >
          </div>
          <span class="font-bold text-zinc-900 dark:text-white tracking-tight"
            >{SITE_TITLE}</span
          >
        </a>
        <div
          class="flex items-center gap-6 text-sm font-medium text-zinc-500 dark:text-zinc-400"
        >
          <a
            href="/"
            class="hover:text-zinc-900 dark:hover:text-zinc-100 transition-colors"
            >博客</a
          >
          <a
            href="#"
            class="hover:text-zinc-900 dark:hover:text-zinc-100 transition-colors"
            >项目</a
          >
          <a
            href="/about"
            class="hover:text-zinc-900 dark:hover:text-zinc-100 transition-colors"
            >关于</a
          >
          <Search />
          <ThemeToggle client:load />
          <!-- <ThemeToggle client:only="react" /> -->
        </div>
      </nav>
    </header>

    <main class="flex-grow w-full max-w-5xl mx-auto px-6 py-12">
      <slot />
    </main>

    <footer
      class="border-t border-zinc-100 dark:border-zinc-800 bg-white dark:bg-zinc-950 py-8 mt-12 transition-colors"
    >
      <div
        class="max-w-5xl mx-auto px-6 flex flex-col md:flex-row justify-between items-center text-sm text-zinc-400 dark:text-zinc-500 gap-4"
      >
        <div class="flex flex-col md:flex-row gap-4 items-center">
          <p>
            &copy; {new Date().getFullYear()}
            {AUTHOR}. All rights reserved.
          </p>
          <span class="hidden md:inline">·</span>
          <div
            class="flex items-center gap-2"
            id="busuanzi_container_site_pv"
            style="display: none;"
          >
            本站总访问量 <span
              id="busuanzi_value_site_pv"
              class="text-zinc-600 dark:text-zinc-300"></span> 次
          </div>
        </div>

        <div class="flex gap-4">
          <a
            href="https://github.com"
            target="_blank"
            rel="noopener noreferrer"
            class="hover:text-zinc-900 dark:hover:text-zinc-100 transition-colors"
            >GitHub</a
          >
          <a
            href="https://twitter.com"
            target="_blank"
            rel="noopener noreferrer"
            class="hover:text-zinc-900 dark:hover:text-zinc-100 transition-colors"
            >Twitter</a
          >
        </div>
      </div>
    </footer>
  </body>
</html>
