---
import { ClientRouter } from "astro:transitions";
import ThemeToggle from "../components/ThemeToggle";
import Search from "../components/Search.astro";
import Footer from "../components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION, AUTHOR } from "../consts";

interface Props {
  title: string;
  description?: string;
}

const { title, description = SITE_DESCRIPTION } = Astro.props;
---

<!doctype html>
<html lang="zh-CN" class="scroll-smooth">
  <head>
    <meta name="baidu-site-verification" content="codeva-Bq9PHADdgr" />
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    <meta
      property="og:image"
      content={new URL(
        `/og/${Astro.url.pathname === "/" ? "hello-刘金荣" : Astro.url.pathname.replace(/^\/blog\//, "").replace(/\/$/, "")}.png`,
        Astro.site || "http://localhost:4321",
      ).href}
    />
    <meta name="twitter:card" content="summary_large_image" />
    <ClientRouter />

    <script is:inline>
      const getTheme = () => {
        if (
          typeof localStorage !== "undefined" &&
          localStorage.getItem("theme")
        ) {
          return localStorage.getItem("theme");
        }
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
          return "dark";
        }
        return "light";
      };

      const theme = getTheme();
      if (theme === "dark") {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }

      document.addEventListener("astro:after-swap", () => {
        const theme = getTheme();
        if (theme === "dark") {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }
      });
    </script>
    <!-- <script
      async
      src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <script>
      // Reload Busuanzi on page swap for View Transitions
      document.addEventListener("astro:page-load", () => {
        // @ts-ignore
        if (window.bszCaller && window.bszTag) {
          // @ts-ignore
          window.bszTag.hides();
          // @ts-ignore
          window.bszTag.shows();
          // @ts-ignore
          window.bszCaller.fetch(
            "//busuanzi.ibruce.info/busuanzi?jsonpCallback=BusuanziCallback",
            function (a) {
              // @ts-ignore
              window.bszTag.hides();
              // @ts-ignore
              window.bszTag.shows();
            },
          );
        }
      });
    </script> -->
    <script>
      document.addEventListener("astro:page-load", () => {
        const bszSrc =
          "//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js";

        // 1. 如果页面上已经有这个脚本了，先删掉它
        const oldScript = document.querySelector(`script[src="${bszSrc}"]`);
        if (oldScript) {
          oldScript.remove();
        }

        // 2. 【关键步骤】暴力清除不蒜子的全局缓存变量
        // 如果不加这两行，不蒜子会以为自己已经加载过了，就不会再次执行
        // @ts-ignore
        window.bszCaller = undefined;
        // @ts-ignore
        window.bszTag = undefined;

        // 3. 创建一个新的脚本标签并插入
        const newScript = document.createElement("script");
        newScript.src = bszSrc;
        newScript.async = true;
        newScript.referrerPolicy = "no-referrer-when-downgrade";

        document.body.appendChild(newScript);
      });
    </script>
    <script is:inline>
      (function () {
        var bp = document.createElement("script");
        var curProtocol = window.location.protocol.split(":")[0];
        if (curProtocol === "https") {
          bp.src = "https://zz.bdstatic.com/linksubmit/push.js";
        } else {
          bp.src = "http://push.zhanzhang.baidu.com/push.js";
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  </head>
  <body
    class="flex flex-col min-h-screen selection:bg-purple-100 selection:text-purple-900 dark:selection:bg-purple-900/30 dark:selection:text-purple-200 relative"
  >
    <!-- Liquid Glass Animated Background -->
    <div
      class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none bg-zinc-50 dark:bg-zinc-950 transition-colors duration-500"
    >
      <div
        class="absolute -top-[20%] -left-[10%] w-[70vw] h-[70vw] rounded-full bg-purple-300/40 dark:bg-purple-900/30 blur-[120px] animate-orb-1"
      >
      </div>
      <div
        class="absolute top-[10%] -right-[10%] w-[60vw] h-[60vw] rounded-full bg-blue-300/40 dark:bg-blue-900/30 blur-[120px] animate-orb-2"
      >
      </div>
      <div
        class="absolute -bottom-[20%] left-[20%] w-[80vw] h-[80vw] rounded-full bg-cyan-300/30 dark:bg-cyan-900/20 blur-[120px] animate-orb-3"
      >
      </div>
      <div
        class="absolute inset-0 bg-white/30 dark:bg-black/30 backdrop-blur-[60px]"
      >
      </div>
    </div>

    <!-- Floating Glass Pill Header -->
    <header
      class="fixed top-6 left-1/2 -translate-x-1/2 z-50 w-[calc(100%-3rem)] max-w-2xl transition-all duration-500"
    >
      <nav
        class="flex h-14 items-center justify-between px-6 rounded-full bg-white/20 dark:bg-zinc-900/20 backdrop-blur-3xl saturate-200 shadow-[0_8px_32px_rgba(0,0,0,0.08),inset_0_0_0_1px_rgba(255,255,255,0.4)] dark:shadow-[0_8px_32px_rgba(0,0,0,0.4),inset_0_0_0_1px_rgba(255,255,255,0.1)] transition-colors"
      >
        <a href="/" class="flex items-center gap-2 group">
          <div
            class="p-1.5 bg-zinc-900 dark:bg-white rounded-lg group-hover:bg-zinc-800 dark:group-hover:bg-zinc-200 transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="text-white dark:text-zinc-900"
              ><path d="m18 16 4-4-4-4"></path><path d="m6 8-4 4 4 4"
              ></path><path d="m14.5 4-5 16"></path></svg
            >
          </div>
          <span class="font-bold text-zinc-900 dark:text-white tracking-tight"
            >{SITE_TITLE}</span
          >
        </a>
        <div
          class="flex items-center gap-6 text-sm font-medium text-zinc-500 dark:text-zinc-400"
        >
          <a
            href="/"
            class="hover:text-zinc-900 dark:hover:text-zinc-100 transition-colors"
            >博客</a
          >
          <a
            href="#"
            class="hover:text-zinc-900 dark:hover:text-zinc-100 transition-colors"
            >项目</a
          >
          <a
            href="/about"
            class="hover:text-zinc-900 dark:hover:text-zinc-100 transition-colors"
            >关于</a
          >
          <Search />
          <ThemeToggle client:load />
          <!-- <ThemeToggle client:only="react" /> -->
        </div>
      </nav>
    </header>

    <main
      class="flex-grow w-full max-w-5xl mx-auto px-6 pt-32 pb-12 relative z-10"
    >
      <slot />
    </main>

    <Footer />
    <script>
      document.addEventListener("astro:page-load", () => {
        const codeBlocks = document.querySelectorAll("pre");

        codeBlocks.forEach((pre) => {
          // Verify if the parent is already a wrapper to avoid double wrapping
          if (pre.parentElement?.classList.contains("code-block-wrapper"))
            return;

          // Create wrapper
          const wrapper = document.createElement("div");
          wrapper.className = "code-block-wrapper relative group my-6";

          // Insert wrapper before pre
          pre.parentElement?.insertBefore(wrapper, pre);

          // Move pre into wrapper
          wrapper.appendChild(pre);

          // Create button
          const button = document.createElement("button");
          button.className =
            "absolute top-3 right-3 p-2 rounded-lg bg-zinc-700/50 hover:bg-zinc-600 text-zinc-300 hover:text-white transition-all opacity-0 group-hover:opacity-100 focus:opacity-100 backdrop-blur-sm";
          button.setAttribute("aria-label", "Copy code");
          button.innerHTML = `
            <span class="copy-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
            </span>
            <span class="check-icon hidden">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-400"><path d="M20 6 9 17l-5-5"/></svg>
            </span>
          `;

          // Add functionality
          button.addEventListener("click", async () => {
            const code = pre.querySelector("code")?.innerText || pre.innerText;
            try {
              await navigator.clipboard.writeText(code);

              const copyIcon = button.querySelector(".copy-icon");
              const checkIcon = button.querySelector(".check-icon");

              if (copyIcon && checkIcon) {
                copyIcon.classList.add("hidden");
                checkIcon.classList.remove("hidden");

                setTimeout(() => {
                  copyIcon.classList.remove("hidden");
                  checkIcon.classList.add("hidden");
                }, 2000);
              }
            } catch (err) {
              console.error("Failed to copy!", err);
            }
          });

          wrapper.appendChild(button);
        });
      });
    </script>
  </body>
</html>
